<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Secure Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script> </head>
<body class="bg-light">

<div class="container mt-5" style="max-width: 500px;">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Secure Payment</h5>
        </div>
        <div class="card-body">
            <p><strong>Total Amount:</strong> <span id="payAmount">RM 0.00</span></p>
            
            <div id="card-element" class="form-control p-3 mb-3"></div>
            <div id="card-errors" class="text-danger mb-3" role="alert"></div>

            <button id="submitBtn" class="btn btn-success w-100" onclick="handlePayment()">
                Pay Now
            </button>
            <div id="loading" class="text-center mt-3" style="display:none;">
                <div class="spinner-border text-primary" role="status"></div>
                <p>Processing Payment...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Initialize Stripe
    const stripe = Stripe('pk_test_51SdmvEG1Ef13Bg4opVrxX5WTuPQFIogSMvIM9j1ElFzl0rG3m6YkW9Wh8IZZRv7t8WwhS6HCN5P6oJW8uMEz8vDu00tEeNEfiT');
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    // 2. Load Booking Data
    const bookingData = JSON.parse(localStorage.getItem("tempBookingData"));
    if (!bookingData) { alert("No booking data found!"); window.location.href="/booking"; }
    
    document.getElementById("payAmount").innerText = "RM " + parseFloat(bookingData.amount).toFixed(2);

    // 3. Handle Payment
    async function handlePayment() {
        setLoading(true);

        try {
            // A. Get Client Secret from Backend
            const initRes = await fetch('/api/booking/payment/initiate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: bookingData.amount })
            });
            const initData = await initRes.json();
            
            if (initData.error) throw new Error(initData.error);

            // B. Confirm Card with Stripe
            const result = await stripe.confirmCardPayment(initData.clientSecret, {
                payment_method: {
                    card: card,
                    billing_details: {
                        name: bookingData.passenger.fullName,
                        email: bookingData.passenger.email
                    }
                }
            });

            if (result.error) {
                throw new Error(result.error.message);
            } else {
                // C. Payment Success -> Finalize Booking
                completeBooking(result.paymentIntent.id);
            }

        } catch (error) {
            document.getElementById('card-errors').innerText = error.message;
            setLoading(false);
        }
    }

    // 4. Save Booking to Database
    async function completeBooking(paymentIntentId) {
        bookingData.stripePaymentIntentId = paymentIntentId;

        const res = await fetch('/api/booking/confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookingData)
        });

        const data = await res.json();
        
        if (res.ok) {
            // Clear temp data
            localStorage.removeItem("tempBookingData");
            // Go to success page with Ticket ID
            window.location.href = `/confirmation?ticketId=${data.ticketId}`;
        } else {
            alert("Payment successful but booking failed. Please contact support.");
        }
    }

    function setLoading(isLoading) {
        document.getElementById("submitBtn").disabled = isLoading;
        document.getElementById("loading").style.display = isLoading ? "block" : "none";
    }
</script>

</body>
</html>